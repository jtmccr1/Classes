---
title: "Lab9"
author: "JT McCrone"
date: "October 29, 2014"
output: html_document
---
I have tried to include comment showing my thought process throughout this lab.  

```{r,echo=FALSE}
require(plyr)
require(ggplot2)
require(reshape2)
require(grid)
require(scales)
require(bbmle)
```


Here we'll load the data for the model.
```{r}
options(stringsAsFactors=FALSE)
theme_set(theme_bw())
gt <- read.csv("http://kinglab.eeb.lsa.umich.edu/480/data/gophertortoise.csv",
                comment.char="#",colClasses=c(date="Date",
                                              sex="factor",elisa="factor"))
arrange(gt,carapace.length,date) -> gt

gt1 <- ddply(gt,~id,subset,date==min(date))
dim(gt1)

mutate(gt1,serostatus=ifelse(elisa=="neg",0,1)) -> gt1
head(gt1)

loglik <- function (p, serostatus) { sum(dbinom(x=serostatus,size=1,
                                                prob=p,log=TRUE))
                                    }

haznll<-function(lambda,carapace.length,serostatus){
  -loglik(p=1-exp(-lambda*carapace.length),serostatus)  # The pobability of being seropositive (1) is 1-exp(-lambda*a) the prob of being seronegative
}
```

In order to get an idea for a starting point for lambda I'll look accros the ages and see how the parameter changes.  To do this I'll group the data together by carapace.length in bins of 25 mm and estimate the age of the group as the mean of the carapace length.  Here I am looking at the probablity of being serotype negative as this is what is most apparent from the equation linking probablility and carapace length in the survival approach.

```{r}
groups<-seq(range(gt1$carapace.length)[1],range(gt1$carapace.length)[2],by=25)
groups<-c(groups,range(gt1$carapace.length)[2])
gt1$group<-apply(gt1,1,function(x) min(which(groups>=as.numeric(x["carapace.length"]))))

moments<-ddply(gt1,~group, summarize, age=mean(carapace.length),neg=length(which(serostatus==0)),total.obs=length(serostatus),p.neg=neg/total.obs,lambda = log(p.neg)/(-age))

moments
ranges<-range(subset(moments,lambda!=0)['lambda'])
```
From here we can see that when $\lambda$ is not 0 it ranges between `ranges`.  I'll start mle2 at 0.005. 
```{r}
fit<-mle2(minuslogl = haznll,start = list(lambda=0.005),data=gt1)

summary(fit)

```

With the model above I estimate the force of infection to be `coef(fit)` with $\text{mm}^{-1}$ as units with a 95% confidence interval of `confint(fit)`.  Which seems pretty tight around lambda.  The model certainly has a different shape when compared to the logistic regression don in class, but I just by looking at the fit I wouldn't say this one is better.  There seems to be a threshold in the data after which the probability for serotype positive increases rapidly that behavior is not captured here.

```{r}
mutate(gt1,fitted=with(as.list(coef(fit)),1-exp(-lambda*carapace.length))) -> gt1
ggplot(data=gt1,mapping=aes(x=carapace.length,color=elisa)) + geom_point(aes(y=serostatus),position='jitter')+ geom_line(aes(y=fitted),color='black')

```



```{r}
lambda<-seq(0.0001,0.05,by=0.0001)
loglike<-sum(dbinom(x=gt1$serostatus,size=1,
                    prob=1-exp(-lambda*gt1$carapace.length),log=TRUE))

```
```{r}
params <- data.frame(lambda=seq(0.0001,0.05,by=0.0001))
                      

ddply(params,~lambda,mutate,
      loglik=with(gt1,-haznll(lambda,carapace.length,serostatus))) -> params

maxloglike<-with(gt1,-haznll(coef(fit),carapace.length,serostatus))

crit <- qchisq(p=0.95,df=1)/2 

p1<-ggplot(data=params,mapping=aes(x=lambda,y=loglik))+ geom_line()+ggtitle("Likelihood Surface")+geom_hline(yintercept=c(maxloglike-crit),color="red")+geom_vline(xintercept=range(params$lambda[params$loglik>maxloglike-crit]),linetype=2,color="red")+ylim(-100,-60)+xlim(0,0.015)+geom_point(aes(x=coef(fit),y=maxloglike),size=5)
crit2 <- qchisq(p=0.999,df=1)/2 
p1<-p1+geom_hline(yintercept=c(maxloglike-crit2),color="blue")+geom_vline(xintercept=range(params$lambda[params$loglik>maxloglike-crit2]),linetype=2,color="blue")
crit3 <- qchisq(p=0.50,df=1)/2;
p1<-p1+geom_hline(yintercept=c(maxloglike-crit3),color="green")+geom_vline(xintercept=range(params$lambda[params$loglik>maxloglike-crit3]),linetype=2,color="green")

p1+ scale_color_manual(values=c("red", "blue", "green"), 
                       name="Confidence intervals",
                       labels=c("95%", "99%", "50%"))+ theme(legend.position=c(.5, .5))
```
### Exercise 2
To get an idea of how the force of infection changes with age I'll plot my estimates from above.

```{r}

ggplot(data=subset(moments,lambda!=0),mapping=aes(x=age, y= lambda))+geom_point(size=3)
```
This should give a rough estimate as I took averages over age groups and calculated an lambda for each group, but it seems like a linear model would work especially for the 125mm to 250 mm range.  So my model is now

$$
\lambda (a) = m \cdot a + b
$$


```{r}
lm(moments$lambda~moments$age)
nll<-function(b,m,carapace.length,serostatus){
  prob<-1-exp(-((m/2)*(carapace.length)^2 + b*carapace.length))
  ll<- -loglik(p=prob,serostatus)
  print(prob)
  print(paste0("b=",b," m=",m))
if (!is.finite(ll)){
ll<- -1e20
}
print(ll)
ll
}

fit2<-mle2(minuslogl = nll,start = list(b=-0.002,m=0.0000287),data=gt1)
```
A plot with the force of infection over age.

```{r}
mutate(gt1,fitted2=with(as.list(coef(fit2)),1-exp(-((m/2)*(carapace.length)^2 + b*carapace.length))),
       force.i=with(as.list(coef(fit2)),m*carapace.length+b)) -> gt1

ggplot(data=gt1,mapping=aes(x=carapace.length,y=force.i))+geom_line()
```

A plot with overlaid predictions and data
```{r}

ggplot(data=gt1,mapping=aes(x=carapace.length,color=elisa)) + geom_point(aes(y=serostatus),position='jitter')+ geom_line(aes(y=fitted2),color='black')

```

Looking at the confidence intervals yeilds

```{r}

pfit2 <- profile(fit2)
plot(pfit2)
confint(pfit2)
```


Using contors to look across these parameters and their confidence intervals

```{r}
params <- expand.grid(a=seq(-8.76,-3.97,by=0.005),
                      b=seq(0.021,0.043,0.0005))
ddply(params,~a+b,mutate,
      loglik=with(gt1,-nll(a,b,carapace.length,serostatus))) -> params
breaks <- logLik(fit)-qchisq(p=c(0.5,0.8,0.9,0.95,0.99,0.999,0.9999),df=2)/2
ggplot(data=params,mapping=aes(x=a,y=b,z=loglik))+
  stat_contour(aes(color=..level..),breaks=breaks)+
  geom_point(x=coef(fit)["a"],y=coef(fit)["b"],shape=3)+
  labs(color=expression(log(L)))

```









### Exercise 3

Here we'll compare the two models used above with one another as well as with the logit model used in class.

?nested models